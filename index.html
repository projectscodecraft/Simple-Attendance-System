<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Attendance System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <style>
      body {
        background: linear-gradient(to right, #74ebd5, #acb6e5);
      }
      .card {
        border-radius: 1.5rem;
      }
    </style>
  </head>
  <body>
    <div
      class="container d-flex justify-content-center align-items-center min-vh-100"
    >
      <div
        class="card shadow-lg p-4 text-center"
        style="max-width: 420px; width: 100%"
      >
        <h2 class="mb-3">📸 Smart Attendance</h2>
        <p class="text-muted">
          Choose your section & subject, then enter your name
        </p>

        <!-- Section Dropdown -->
        <select id="section" class="form-select mb-3">
          <option value="">Section</option>
        </select>

        <!-- Subject Dropdown -->
        <select id="subject" class="form-select mb-3">
          <option value="">Subject</option>
        </select>

        <!-- Name Input -->
        <input
          type="text"
          id="studentName"
          class="form-control mb-3"
          placeholder="Surname, First Name M."
          required
        />

        <!-- Camera Section -->
        <div class="mb-3 text-center">
          <div class="border rounded shadow-sm d-inline-block p-1 bg-white">
            <video
              id="video"
              autoplay
              playsinline
              class="rounded"
              style="width: 100%; max-width: 320px; height: auto"
            ></video>
          </div>
          <canvas
            id="canvas"
            width="320"
            height="240"
            style="display: none"
          ></canvas>
        </div>

        <!-- Buttons -->
        <div>
          <button id="startCamera" class="btn btn-primary w-100 mb-2">
            🎥 Start Camera
          </button>
          <button id="captureBtn" class="btn btn-success w-100">
            ✅ Mark Attendance
          </button>
        </div>
      </div>
    </div>

    <!-- 🔹 Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
          <h4 class="text-success">✔ Attendance Recorded!</h4>
          <p class="text-muted">Redirecting to your attendance calendar...</p>
        </div>
      </div>
    </div>

    <script>
      // 🔹 Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyDqjFTrX4cWHrDsqi77LglivP75hFr3ch8",
        authDomain: "attendance-system-8336a.firebaseapp.com",
        databaseURL:
          "https://attendance-system-8336a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "attendance-system-8336a",
        storageBucket: "attendance-system-8336a.appspot.com",
        messagingSenderId: "789681848272",
        appId: "1:789681848272:web:40318e1ee8d9c8871443d5",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const context = canvas.getContext("2d");

      // Start camera
      document.getElementById("startCamera").addEventListener("click", () => {
        navigator.mediaDevices
          .getUserMedia({ video: true })
          .then((stream) => {
            video.srcObject = stream;
          })
          .catch((err) => {
            alert("Camera access denied: " + err.message);
          });
      });

      // Capture attendance
      document.getElementById("captureBtn").addEventListener("click", async () => {
        const name = document.getElementById("studentName").value.trim();
        const section = document.getElementById("section").value;
        const subject = document.getElementById("subject").value;

        if (!section || !subject) {
          alert("Please select Section and Subject.");
          return;
        }

        // Capture photo
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const dataUrl = canvas.toDataURL("image/png");

        // 🔹 Check brightness of the image (to prevent covered camera)
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        let totalBrightness = 0;
        for (let i = 0; i < imageData.data.length; i += 4) {
          const r = imageData.data[i];
          const g = imageData.data[i + 1];
          const b = imageData.data[i + 2];
          const brightness = (r + g + b) / 3;
          totalBrightness += brightness;
        }
        const avgBrightness = totalBrightness / (imageData.data.length / 4);

        if (avgBrightness < 30) { // 👈 Adjust threshold as needed
          alert("⚠️ Please uncover your camera. No face detected.");
          return;
        }

        try {
          await db.ref("attendance").push({
            name,
            section,
            subject,
            timestamp: Date.now(),
            photo: dataUrl,
          });

          // Show success modal
          const successModal = new bootstrap.Modal(
            document.getElementById("successModal")
          );
          successModal.show();

          // Redirect after 3 seconds
          setTimeout(() => {
            window.location.href = `my-attendance.html?name=${encodeURIComponent(
              name
            )}`;
          }, 3000);
        } catch (error) {
          console.error("Error:", error);
          alert("Error saving attendance: " + error.message);
        }
      });

      // Load sections & subjects
      fetch("edit-here.json?v=" + new Date().getTime())
        .then((response) => response.json())
        .then((data) => {
          // Populate Sections
          const sectionSelect = document.getElementById("section");
          data.sections.forEach((section) => {
            const opt = document.createElement("option");
            opt.value = section;
            opt.textContent = section;
            sectionSelect.appendChild(opt);
          });

          // Populate Subjects
          const subjectSelect = document.getElementById("subject");
          data.subjects.forEach((subject) => {
            const opt = document.createElement("option");
            opt.value = subject.code;
            opt.textContent = `${subject.code} - ${subject.name}`;
            subjectSelect.appendChild(opt);
          });
        })
        .catch((error) => {
          console.error("Error loading edit-here.json:", error);
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
