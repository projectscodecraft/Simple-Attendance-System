<script>
  // ðŸ”¹ Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyDqjFTrX4cWHrDsqi77LglivP75hFr3ch8",
    authDomain: "attendance-system-8336a.firebaseapp.com",
    databaseURL:
      "https://attendance-system-8336a-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "attendance-system-8336a",
    storageBucket: "attendance-system-8336a.appspot.com",
    messagingSenderId: "789681848272",
    appId: "1:789681848272:web:40318e1ee8d9c8871443d5",
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const context = canvas.getContext("2d");
  const captureBtn = document.getElementById("captureBtn");
  let cameraStarted = false;

  // Disable button until camera starts
  captureBtn.disabled = true;

  // Start camera
  document.getElementById("startCamera").addEventListener("click", () => {
    navigator.mediaDevices
      .getUserMedia({ video: true })
      .then((stream) => {
        video.srcObject = stream;
        cameraStarted = true;
        captureBtn.disabled = false;
      })
      .catch((err) => {
        alert("Camera access denied: " + err.message);
      });
  });

  // Capture attendance
  captureBtn.addEventListener("click", async () => {
    if (!cameraStarted) {
      alert("Please start the camera first!");
      return;
    }

    const name = document.getElementById("studentName").value.trim();
    const section = document.getElementById("section").value;
    const subject = document.getElementById("subject").value;

    if (!name) {
      alert("Please enter your name.");
      return;
    }
    if (!section || !subject) {
      alert("Please select Section and Subject.");
      return;
    }

    // Capture photo
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL("image/png");

    // Check if photo exists
    if (!dataUrl || dataUrl.length < 1000) {
      alert("Please capture your photo before marking attendance.");
      return;
    }

    try {
      const ref = db.ref("attendance");

      // Query last attendance for this student
      const snapshot = await ref
        .orderByChild("name")
        .equalTo(name)
        .limitToLast(1) // only get the latest
        .get();

      let canMark = true;
      snapshot.forEach((childSnapshot) => {
        const record = childSnapshot.val();
        if (
          record.section === section &&
          record.subject === subject &&
          Date.now() - record.timestamp < 5 * 60 * 1000 // 5 minutes
        ) {
          canMark = false;
        }
      });

      if (!canMark) {
        alert(
          "You already marked attendance for this subject. Try again after 5 minutes."
        );
        return;
      }

      // Save attendance
      await ref.push({
        name,
        section,
        subject,
        timestamp: Date.now(),
        photo: dataUrl,
      });

      // Show success modal
      const successModal = new bootstrap.Modal(
        document.getElementById("successModal")
      );
      successModal.show();

      setTimeout(() => {
        window.location.href = `my-attendance.html?name=${encodeURIComponent(
          name
        )}`;
      }, 3000);
    } catch (error) {
      console.error("Error:", error);
      alert("Error saving attendance: " + error.message);
    }
  });

  // Populate dropdowns
  fetch("edit-here.json?v=" + new Date().getTime())
    .then((response) => response.json())
    .then((data) => {
      const sectionSelect = document.getElementById("section");
      data.sections.forEach((section) => {
        const opt = document.createElement("option");
        opt.value = section;
        opt.textContent = section;
        sectionSelect.appendChild(opt);
      });

      const subjectSelect = document.getElementById("subject");
      data.subjects.forEach((subject) => {
        const opt = document.createElement("option");
        opt.value = subject.code;
        opt.textContent = `${subject.code} - ${subject.name}`;
        subjectSelect.appendChild(opt);
      });
    })
    .catch((error) => {
      console.error("Error loading edit-here.json:", error);
    });
</script>
